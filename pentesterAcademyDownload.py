#!/bin/python
# Script by Alex Lima (nigofl)
from bs4 import BeautifulSoup
import os, sys, urllib, requests

cookies = {}
def set_cookies():
    print("Please insert the following values of cookies:")
    sacsid = raw_input("SACSID: ")
    wootracker = raw_input("wooTracker: ")
    cookies = {'SACSID':sacsid, 'wooTracker': wootracker }
    return cookies

def url_download(url):
    html = urllib.urlopen(url)
    bt = BeautifulSoup(html.read(), "lxml")
    return bt

def check_filename(directory, file):
    while os.path.isfile(directory + "/" + file):
        file = "_"+file
    return file

def check_directory(directory):
    if os.path.isdir(directory):
        print("The directory %s exists. Select a name to create the directory, or hit enter to use the exists directory." % directory)
        folder = raw_input("Directory name: ")
        if folder:
            return check_directory(folder)
        else:
            print("[+] - Using directory :" + os.getcwd() + "/" + directory)
            return directory
    print("[+] - Created directory :" + os.getcwd() + "/" + directory)
    os.mkdir(directory)
    return directory

def course_select(id):
    dhtml = url_download("https://www.pentesteracademy.com/course?id="+id)
    h4 = dhtml.select('h4.media-heading')
    course_title = dhtml.title.text
    print("[+] Start download " + course_title)
    print("[+] Getting Links:")
    print("[+] Select the downloads do you want:")
    items = {}
    for item in h4:
        items[item.a['href'].split("id=")[1]] = item.a.text
        print("[%s] - %s" % (item.a['href'].split("id=")[1], item.a.text))
    selected_downloads = raw_input("Select downloads (ex: 1 2 13-15) or hit enter for all: ")
    indices = {}
    for a in selected_downloads.split():
        if a.find("-") != -1:
            b = a.split("-")
            for i in range(int(b[0]),int(b[1])+1,1):
                indices[str(i)] = items[str(i)]
        else:
            indices[a] = items[a]
    if indices:
        itens_select(indices, course_title)
    else:
        itens_select(items, course_title)

def itens_select(list_download, directory):
    cookies = set_cookies()
    folder = check_directory(directory)
    for key, value in list_download.iteritems():
        print("[+] - "+value)
        subhtml = url_download("https://www.pentesteracademy.com/video?id="+key)
        itens = subhtml.find(id="home")
        arquivos = itens.find_all('a')
        for arquivo in arquivos:
            url_file = requests.get("https://www.pentesteracademy.com"+arquivo['href'],cookies=cookies, allow_redirects=True)
            nomeArq = url_file.url.split("?")[0].split("/")[-1]
            filename = check_filename(folder, nomeArq)
            print("     [+] - "+filename)
            open(folder+"/"+filename, 'wb').write(url_file.content)

def main ():
    dhtml = url_download("https://www.pentesteracademy.com/topics")
    h3 = dhtml.select('h3.media-heading')
    print("Hello All.. Welcome to Pentester Academy downloader, select the course do you want: ")
    print(dhtml.title.text)
    for course in h3:
        print("["+course.a['href'].split("id=")[1]+"] - " + course.a.text)
    course_id = raw_input("Select the course: ")
    print("Fantastic.. Let`s start the download...")
    course_select(course_id)

if __name__ == "__main__":
    main()